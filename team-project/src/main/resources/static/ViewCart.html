<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <title>Î¤Î¿ ÎšÎ±Î»Î¬Î¸Î¹ ÎœÎ¿Ï…</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

    <div class="inventory-container">
        <div class="header-section">
            <h1>Î¤Î¿ ÎšÎ±Î»Î¬Î¸Î¹ Î‘Î³Î¿ÏÏÎ½</h1>
            <p>Î”ÎµÎ¯Ï„Îµ ÎºÎ±Î¹ ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± ÏƒÎ±Ï‚</p>
        </div>

        <div id="messageArea"></div>

        <div id="loadingArea" class="loading">
            Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÎºÎ±Î»Î±Î¸Î¹Î¿Ï...
        </div>

        <div id="cartArea" style="display:none;">
            <table class="products-table" id="resultsTable">
                <thead>
                    <tr>
                        <th>Î ÏÎ¿ÏŠÏŒÎ½</th>
                        <th>ÎœÎ¬ÏÎºÎ±</th>
                        <th>Î¤Î¹Î¼Î® ÎœÎ¿Î½Î¬Î´Î±Ï‚</th>
                        <th>Î Î¿ÏƒÏŒÏ„Î·Ï„Î±</th>
                        <th>Î£ÏÎ½Î¿Î»Î¿</th>
                        <th>Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th>
                    </tr>
                </thead>
                <tbody id="cartTableBody">
                </tbody>
            </table>

            <div class="store-info" style="margin-top: 20px; text-align: right; padding: 20px;">
                <h3 style="font-size: 24px;">Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î Î¿ÏƒÏŒ: <span id="totalCartPrice" style="color: #28a745;">0.00</span> â‚¬</h3>
                <button id="checkoutBtn" onclick="processCheckout()" style="width: 250px; background-color: #28a745; margin-top: 15px;">ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î‘Î³Î¿ÏÎ¬Ï‚</button>
            </div>
        </div>

        <div id="emptyCart" class="empty-state" style="display:none;">
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ›’</div>
            <h3>Î¤Î¿ ÎºÎ±Î»Î¬Î¸Î¹ ÏƒÎ±Ï‚ ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿</h3>
            <p>Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹ Î±ÎºÏŒÎ¼Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±.</p>
            <a href="searchProduct.html" class="back-btn" style="background-color: #007bff;">Î Î¯ÏƒÏ‰ ÏƒÏ„Î± Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±</a>
        </div>

        <nav style="text-align: center; margin-top: 20px;">
            <a href="#" id="backBtn" class="back-btn">Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î·Î½ Î‘ÏÏ‡Î¹ÎºÎ®</a>
        </nav>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const citizenAfm = urlParams.get('citizenAfm') || '111222333';

        document.getElementById('backBtn').href = 'citizenLandingPage.html?citizenAfm=' + citizenAfm;

        $(document).ready(function() {
            loadCart();
        });

        function loadCart() {
            $('#loadingArea').show();
            $('#cartArea').hide();
            $('#emptyCart').hide();

            $.ajax({
                url: "http://localhost:8080/cart/view/" + citizenAfm,
                method: "GET",
                success: function(cart) {
                    $('#loadingArea').hide();
                    if (!cart || !cart.products || cart.products.length === 0) {
                        $('#emptyCart').show();
                        return;
                    }
                    displayCartItems(cart);
                    $('#cartArea').show();
                },
                error: function() {
                    $('#loadingArea').hide();
                    $('#emptyCart').show();
                }
            });
        }

        function displayCartItems(cart) {
            const tbody = $('#cartTableBody');
            tbody.empty();

            cart.products.forEach(item => {
                const itemTotal = item.product.price * item.quantity;
                const row = `
                    <tr>
                        <td><span class="product-type">${item.product.type}</span></td>
                        <td>${item.product.brand}</td>
                        <td><span class="product-price">${item.product.price.toFixed(2)} â‚¬</span></td>
                        <td><strong>${item.quantity}</strong></td>
                        <td><strong>${itemTotal.toFixed(2)} â‚¬</strong></td>
                        <td>
                            <button onclick="removeFromCart('${item.product.type}')" 
                                    style="background-color: #dc3545; width: auto; padding: 5px 10px;">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            $('#totalCartPrice').text(cart.total_price.toFixed(2));
        }

        function removeFromCart(productType) {
            if (!confirm("Î˜Î­Î»ÎµÏ„Îµ Î½Î± Î±Ï†Î±Î¹ÏÎ­ÏƒÎµÏ„Îµ Ï„Î¿ Ï€ÏÎ¿ÏŠÏŒÎ½ Î±Ï€ÏŒ Ï„Î¿ ÎºÎ±Î»Î¬Î¸Î¹;")) return;

            $.ajax({
                url: "http://localhost:8080/cart/remove?citizenAfm=" + citizenAfm + "&productType=" + productType,
                method: "DELETE",
                success: function() {
                    loadCart(); // Î•Ï€Î±Î½Î±Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Î³Î¹Î± Î½Î± Î´Î¿ÏÎ¼Îµ Ï„Î¿ Î±Î½Î±Î½ÎµÏ‰Î¼Î­Î½Î¿ ÎºÎ±Î»Î¬Î¸Î¹
                },
                error: function(xhr) {
                    alert("Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®: " + xhr.responseText);
                }
            });
        }

        function processCheckout() {
            const checkoutBtn = $('#checkoutBtn');
            checkoutBtn.prop('disabled', true).text('Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±...');

            $.ajax({
                url: "http://localhost:8080/api/orders/checkout",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ afm: parseInt(citizenAfm) }),
                success: function(response) {
                    alert("Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚: " + response.id);
                    window.location.href = 'citizenLandingPage.html?citizenAfm=' + citizenAfm;
                },
                error: function(xhr) {
                    alert("Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·: " + xhr.responseText);
                    checkoutBtn.prop('disabled', false).text('ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î‘Î³Î¿ÏÎ¬Ï‚');
                }
            });
        }
    </script>
</body>
</html>