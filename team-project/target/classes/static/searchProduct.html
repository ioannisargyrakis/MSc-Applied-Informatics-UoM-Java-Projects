<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <title>Αναζήτηση Προϊόντων</title>
	<link rel="stylesheet" href="style.css">
</head>
<body>
    <h2 style="text-align:center;">Αναζήτηση Προϊόντων</h2> 

	<div class="searchTable">
		<table>
		    <tr>
			   <td> Τύπος: </td>
				<td> <input type='text' id='type'> </td>
			</tr>
			<tr>
				<td> Μάρκα: </td>
				<td> <input type='text' id='brand'> </td>
			</tr>
		</table>
		
		<table>
			<tr>
			   <td> Τιμή Από: </td>
			   <td> <input type='number' id='minPrice'> </td>
			</tr>
			<tr>
			   <td> Τιμή Έως: </td>
			   <td> <input type='number' id='maxPrice'> </td>
			</tr>
		</table>
    </div>

    <div>
         <button id="searchButton" onclick="searchProducts()">Αναζήτηση </button>
    </div>

    <table class="resultsTable" id="resultsTable">
		<thead>
		    <tr>
		        <th>Τύπος</th>
		        <th>Μάρκα</th>
		        <th>Τιμή</th>
		        <th>Περιγραφή</th>
		        <th>Διαθεσιμότητα</th>
		        <th>Αγορά</th>
		    </tr>
		</thead>
		<tbody id="resultsBody">
			</tbody>
    </table>
	
	<div>
		<nav style="text-align: center; margin-top: 20px;">
			 <a href="#" id="cartBtn" class="cart-btn">Μετάβαση στο καλάθι αγορών</a>
		</nav>
	</div>
	
	<div>
		<nav style="text-align: center; margin-top: 20px;">
		     <a href="#" id="backBtn" class="back-btn">Επιστροφή στην Αρχική</a>
		</nav>
	</div>
	
	<script>
		const urlParams = new URLSearchParams(window.location.search);
		const citizenAfm = urlParams.get('citizenAfm');

		document.getElementById('backBtn').href = 'citizenLandingPage.html?citizenAfm=' + citizenAfm;
		document.getElementById('cartBtn').href = 'ViewCart.html?citizenAfm=' + citizenAfm;
		
		let cartCount = 0;
		
	    function addToCart() {
	        cartCount++;
	        document.getElementById("cart-count").innerText = cartCount;
	    } 
	    
	    function changeQty(productType, delta) {
	        var qtyInput = document.getElementById('qty-' + productType);
	        if (qtyInput) {
	            var currentVal = parseInt(qtyInput.value);
	            if (currentVal + delta >= 1) {
	                qtyInput.value = currentVal + delta;
	            }
	        }
	    }
	    
	    function searchProducts() {
	        var minPriceValue = document.getElementById("minPrice").value;
	        var maxPriceValue = document.getElementById("maxPrice").value;

	        var searchCriteria = {
	            type: document.getElementById("type").value || null,
	            brand: document.getElementById("brand").value || null,
	            minPrice: minPriceValue ? parseFloat(minPriceValue) : null,
	            maxPrice: maxPriceValue ? parseFloat(maxPriceValue) : null
	        };

	        var settings = {
	            "url": "http://localhost:8080/search",
	            "method": "POST",
	            "timeout": 0,
	            "headers": {
	                "Content-Type": "application/json"
	            },
	            "data": JSON.stringify(searchCriteria)
	        };

	        $.ajax(settings).done(function (response) {
	            var tableBody = $("#resultsTable tbody");
	            tableBody.empty(); 

	            if (!response || response.length === 0) {
	                tableBody.append("<tr><td colspan='6' style='text-align:center;'>Δεν βρέθηκαν προϊόντα.</td></tr>");
	                return;
	            }

	            response.forEach(function(product) {
	                var row = "<tr>" +
	                    "<td>" + product.type + "</td>" +
	                    "<td>" + product.brand + "</td>" +
	                    "<td>" + product.price + " €</td>" +
	                    "<td>" + product.description + "</td>" +
	                    "<td>" + product.numberOfProducts + " τεμ.</td>" +
	                    "<td>" +
	                        "<div style='display: flex; align-items: center; justify-content: center; gap: 5px;'>" +
	                            "<button type='button' onclick='changeQty(\"" + product.type + "\", -1)'>-</button>" +
	                            "<input type='number' id='qty-" + product.type + "' value='1' min='1' " +
	                            "style='width: 50px; height: 30px; text-align: center; padding: 0; font-size: 16px; font-weight: bold; border: 1px solid #ccc;' readonly>" +
	                            "<button type='button' onclick='changeQty(\"" + product.type + "\", 1)'>+</button>" +
	                            "<button class='btn-add' onclick='addProduct(\"" + product.type + "\")' style='margin-left: 10px;'>Προσθήκη</button>" +
	                        "</div>" +
	                    "</td>" +
	                "</tr>";
	                tableBody.append(row); 
	            });
	        }).fail(function (jqXHR) {
	            alert("Σφάλμα κατά την αναζήτηση: " + jqXHR.status);
	        });
	    }
	    
		function addProduct(productType) {
		    
		    const urlParams = new URLSearchParams(window.location.search);
		    const citizenAfm = urlParams.get('citizenAfm');

		    if (!citizenAfm) {
		        alert("Σφάλμα: Δεν βρέθηκε AFM χρήστη. Παρακαλώ συνδεθείτε ξανά.");
		        return;
		    }

		    
		    var qtyElement = document.getElementById('qty-' + productType);
		    var selectedQuantity = qtyElement ? parseInt(qtyElement.value) : 1;

		    $.ajax({
		        url: "http://localhost:8080/cart/add",
		        method: "POST",
		        contentType: "application/json",
		        data: JSON.stringify({
		            citizenAfm: parseInt(citizenAfm), 
		            productType: productType,
		            quantity: selectedQuantity
		        })
		    })
		    .done(function () {
		        cartCount += selectedQuantity; 
		        document.getElementById("cart-count").innerText = cartCount;
		        alert("Προστέθηκαν " + selectedQuantity + " τεμάχια στο καλάθι!");
		    })
		    .fail(function (err) {
		        console.error(err);
		        alert("Αποτυχία προσθήκης: " + err.responseText);
		    });
		}
	</script>

</body>
</html>