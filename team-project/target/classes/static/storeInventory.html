<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î‘Ï€Î¿Î¸Î­Î¼Î±Ï„Î¿Ï‚</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="inventory-container">
        <div class="header-section">
            <h1>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î‘Ï€Î¿Î¸Î­Î¼Î±Ï„Î¿Ï‚ ÎšÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚</h1>
            <p>Î•Î½Î·Î¼ÎµÏÏÏƒÏ„Îµ Ï„Î¹Ï‚ Ï€Î¿ÏƒÏŒÏ„Î·Ï„ÎµÏ‚ Ï„Ï‰Î½ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½ ÏƒÎ±Ï‚</p>
        </div>

        <div id="messageArea"></div>

        <div class="store-info" id="storeInfo" style="display:none;">
            <h3 id="storeName"></h3>
            <p>Î‘Î¦Îœ: <span id="storeAfm"></span></p>
        </div>

        <div id="loadingArea" class="loading">
            Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½...
        </div>

        <div id="productsArea" style="display:none;">
            <table class="products-table">
                <thead>
                    <tr>
                        <th>Î ÏÎ¿ÏŠÏŒÎ½</th>
                        <th>Î¤Î¹Î¼Î®</th>
                        <th>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</th>
                        <th>Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î Î¿ÏƒÏŒÏ„Î·Ï„Î±</th>
                        <th>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                </tbody>
            </table>
        </div>

        <div id="emptyState" class="empty-state" style="display:none;">
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“­</div>
            <h3>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±</h3>
            <p>Î¤Î¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î¬ ÏƒÎ±Ï‚ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î±ÎºÏŒÎ¼Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±.</p>
        </div>

        <a href='#' id="backBtn" class="back-btn">â† Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î·Î½ Î‘ÏÏ‡Î¹ÎºÎ® Î¿Î¸ÏŒÎ½Î· ÎºÎ±Ï„Î±ÏƒÎ®Î¼Î±Ï„Î¿Ï‚</a>
    </div>

    <script>
        // Get store AFM from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const storeAfm = urlParams.get('storeAfm') || '121212121';
		
		document.getElementById('backBtn').href = 'storeLandingPage.html?storeAfm=' + storeAfm;
		
        let products = [];
        let changedProducts = new Set();

        $(document).ready(function() {
            loadStoreProducts();
        });

        function loadStoreProducts() {
            $('#loadingArea').show();
            $('#productsArea').hide();
            $('#emptyState').hide();

            $.ajax({
                url: `http://localhost:8080/store/${storeAfm}/products`,
                method: 'GET',
                success: function(response) {
                    $('#loadingArea').hide();
                    products = response;

                    if (products.length === 0) {
                        $('#emptyState').show();
                    } else {
                        displayProducts();
                        $('#productsArea').show();
                    }

                    if (products.length > 0 && products[0].store) {
                        $('#storeInfo').show();
                        $('#storeName').text(products[0].store.shopName || 'ÎšÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î±');
                        $('#storeAfm').text(storeAfm);
                    }
                },
                error: function(jqXHR) {
                    $('#loadingArea').hide();
                    showMessage('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Ï‰Î½ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½: ' + 
                        (jqXHR.responseText || 'Î¤Î¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ'), 'error');
                }
            });
        }

        function displayProducts() {
            const tbody = $('#productsTableBody');
            tbody.empty();

            products.forEach((product, index) => {
                const row = `
                    <tr id="product-row-${index}" data-product-type="${product.type}">
                        <td>
                            <div class="product-info">
                                <span class="product-type">${product.type}</span>
                                <span class="product-brand">${product.brand}</span>
                            </div>
                        </td>
                        <td><span class="product-price">${product.price.toFixed(2)} â‚¬</span></td>
                        <td>${product.description || '-'}</td>
                        <td>
                            <div class="quantity-display" id="qty-display-${index}">
                                ${product.numberOfProducts}
                            </div>
                        </td>
                        <td>
                            <div class="quantity-controls">
                                <button class="quantity-btn decrease" 
                                        onclick="decreaseQuantity(${index})"
                                        title="ÎœÎµÎ¯Ï‰ÏƒÎ·">
                                    âˆ’
                                </button>
                                <button class="quantity-btn" 
                                        onclick="increaseQuantity(${index})"
                                        title="Î‘ÏÎ¾Î·ÏƒÎ·">
                                    +
                                </button>
                                <button class="save-btn" 
                                        id="save-btn-${index}"
                                        onclick="saveQuantity(${index})"
                                        style="display:none;">
                                    Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function increaseQuantity(index) {
            products[index].numberOfProducts++;
            updateQuantityDisplay(index);
            markAsChanged(index);
        }

        function decreaseQuantity(index) {
            if (products[index].numberOfProducts > 0) {
                products[index].numberOfProducts--;
                updateQuantityDisplay(index);
                markAsChanged(index);
            } else {
                showMessage('Î— Ï€Î¿ÏƒÏŒÏ„Î·Ï„Î± Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ¯Î½Î±Î¹ Î±ÏÎ½Î·Ï„Î¹ÎºÎ®!', 'error');
            }
        }

        function updateQuantityDisplay(index) {
            $(`#qty-display-${index}`).text(products[index].numberOfProducts);
        }

        function markAsChanged(index) {
            changedProducts.add(index);
            $(`#save-btn-${index}`).show();
            $(`#product-row-${index}`).addClass('changed-indicator');
            
            setTimeout(() => {
                $(`#product-row-${index}`).removeClass('changed-indicator');
            }, 500);
        }

        function saveQuantity(index) {
            const product = products[index];
            const saveBtn = $(`#save-btn-${index}`);
            
            saveBtn.prop('disabled', true).text('Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·...');

            $.ajax({
                url: `http://localhost:8080/product/${encodeURIComponent(product.type)}/quantity?quantity=${product.numberOfProducts}`,
                method: 'PUT',
                success: function(response) {
                    showMessage(response, 'success');
                    saveBtn.hide().prop('disabled', false).text('Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·');
                    changedProducts.delete(index);
                },
                error: function(jqXHR) {
                    showMessage('Î£Ï†Î¬Î»Î¼Î±: ' + (jqXHR.responseText || 'Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚'), 'error');
                    saveBtn.prop('disabled', false).text('Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·');
                }
            });
        }

        function saveAllChanges() {
            if (changedProducts.size === 0) {
                showMessage('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î»Î»Î±Î³Î­Ï‚ Î³Î¹Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·', 'error');
                return;
            }

            let completed = 0;
            const total = changedProducts.size;

            changedProducts.forEach(index => {
                const product = products[index];

                $.ajax({
                    url: `http://localhost:8080/product/${encodeURIComponent(product.type)}/quantity?quantity=${product.numberOfProducts}`,
                    method: 'PUT',
                    success: function() {
                        completed++;
                        if (completed === total) {
                            showMessage(`ÎŒÎ»ÎµÏ‚ Î¿Î¹ Î±Î»Î»Î±Î³Î­Ï‚ (${total}) Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!`, 'success');
                            changedProducts.clear();
                            $('.save-btn').hide();
                        }
                    },
                    error: function(jqXHR) {
                        showMessage(`Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î¿Ï… ${product.type}`, 'error');
                    }
                });
            });
        }

        function showMessage(message, type) {
            const messageClass = type === 'error' ? 'error-message' : 'success-message';
            const messageHtml = `<div class="${messageClass}">${message}</div>`;
            
            $('#messageArea').html(messageHtml);
            
            // Auto-hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    $('#messageArea').fadeOut(function() {
                        $(this).html('').show();
                    });
                }, 3000);
            }
        }
    </script>

</body>
</html>